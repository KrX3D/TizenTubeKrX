# -----------------------------------------------------------------------------
# Build, publish, and cleanup TizenTube on npm
#
# WHAT THIS WORKFLOW DOES
# -----------------------
# - Runs on every push to the `main` branch (build + verification)
# - Runs again when a GitHub Release is published (build + npm publish + cleanup)
# - Builds:
#     - dist/userScript.js  (browser userscript, bundled & minified)
#     - dist/service.js     (DIAL service, bundled with Rollup)
# - Publishes the package to https://www.npmjs.com on release only
# - Automatically removes old versions from npm (within 72-hour window)
# - Deprecates older versions (beyond 72-hour window) if any remain
# - Purges jsDelivr CDN cache after publishing
#
# WHEN IT RUNS
# ------------
# push to main:
#   - Builds the project
#   - Does NOT publish to npm
#
# release (published):
#   - Builds the project
#   - Publishes to npm
#   - Removes old versions (≤72 hours old, keeps current version only)
#   - Deprecates very old versions (>72 hours, if unpublish fails)
#   - Purges jsDelivr cache
#
# AUTOMATIC VERSION CLEANUP
# -------------------------
# After publishing a new version, this workflow automatically:
# - Identifies all versions except the newly published one
# - Unpublishes versions that are ≤72 hours old (npm policy allows this)
# - Deprecates versions >72 hours old (unpublish no longer allowed)
# - Result: Only the latest version remains active on npm
#
# Note: npm allows unpublishing versions within ~72 hours of publication.
# After that window, versions can only be deprecated, not removed.
#
# PREREQUISITES (REQUIRED)
# -----------------------
# 1) Create an npm account:
#    https://www.npmjs.com/signup
#
# 2) Create an npm access token:
#    - npm → Profile → Access Tokens
#    - Click "Generate New Token"
#    - Token name: anything you want
#    - CHECK: "Bypass two-factor authentication (2FA)"
#    - Packages and scopes:
#        - Permissions: Read and Write
#        - Scope: All packages
#    - Expiration date: e.g. 90 days
#    - Click "Generate token" and COPY it
#
# 3) Add the token to GitHub Secrets:
#    - GitHub repository → Settings
#    - Security → Secrets and variables → Actions
#    - Repository secrets → New repository secret
#        Name:   NPM_TOKEN
#        Secret: <paste npm token here>
#
# PACKAGE REQUIREMENTS
# --------------------
# - package.json must contain a unique name, e.g.:
#     "@krx3d/tizentube"
# - The version MUST be increased before each release
#   (npm will reject duplicate versions)
#
# HOW TO PUBLISH A NEW VERSION
# ----------------------------
# 1) Bump "version" in package.json
# 2) Commit and push to `main`
# 3) Create a GitHub Release
# 4) When the release is published:
#      → GitHub Actions builds
#      → npm publish runs automatically
#      → Old versions are automatically removed
#      → jsDelivr cache is purged
#
# CONFIGURATION
# -------------
# - PACKAGE_NAME: Set to your npm package name (e.g., '@krx3d/tizentube')
# - NODE_VERSION: Node.js version to use (default: '20')
# - UNPUBLISH_WINDOW_HOURS: How long versions can be unpublished (default: '72')
#
# -----------------------------------------------------------------------------

name: Build, publish and cleanup old npm versions

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
  release:
    types: [published]

# Allow this workflow to push back changes to the repo
permissions:
  contents: write

env:
  PACKAGE_NAME: '@krx3d/tizentube2'
  PACKAGE_NAME_GH: 'KrX3D/TizenTube'
  NODE_VERSION: '20'
  UNPUBLISH_WINDOW_HOURS: '72'

jobs:
  build-publish-clean:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # ensure the checkout action leaves credentials so we can push
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          #registry-url: https://registry.npmjs.org/

      # ----------------------------
      # Build mods (userScript.js)
      # ----------------------------
      - name: Clean dist
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist

      - name: Install mods dependencies
        run: |
          set -euo pipefail
          cd mods
          npm ci

      - name: Update Browserslist DB (mods)
        run: |
          set -euo pipefail
          cd mods
          npx update-browserslist-db@latest

      - name: Build mods (rollup)
        run: |
          set -euo pipefail
          cd mods
          npx rollup -c

      # ----------------------------
      # Build service (service.js)
      # ----------------------------
      - name: Install service dependencies
        run: |
          set -euo pipefail
          cd service
          npm ci

      - name: Build service (rollup)
        run: |
          set -euo pipefail
          cd service
          npx rollup -c

      # ----------------------------
      # Verify output
      # ----------------------------
      - name: Verify dist output
        run: |
          set -euo pipefail
          echo "Listing dist/ (should contain built outputs):"
          ls -lah dist || true
          test -f dist/userScript.js
          test -f dist/service.js

      # ----------------------------
      # Copy built JS to repo root and commit (overwrites)
      # ----------------------------
      - name: Copy built JS to repo root and commit
        run: |
          set -euo pipefail
          echo "Copying dist/*.js to repository root (overwriting existing files)..."
          cp -f dist/userScript.js ./userScript.js
          cp -f dist/service.js ./service.js

          # configure git user
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # stage files
          git add userScript.js service.js

          # commit only if staged changes exist
          if git diff --staged --quiet; then
            echo "No changes to built files — skipping commit."
          else
            git commit -m "chore(build): update built userScript.js and service.js from CI [skip ci]"
            echo "Pushing updated built files to repo..."
            git push origin HEAD:main
          fi

      # --------------------
      # NPM AUTH
      # --------------------
      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc
          npm whoami
          echo "✓ npm auth OK"

      # --------------------
      # PUBLISH
      # --------------------
      - name: Publish package to npm
        run: |
          set -euo pipefail
          echo "Publishing package..."
          npm publish --access public

      - name: Wait for npm propagation (after publish)
        run: |
          echo "Waiting for npm propagation..."
          sleep 10

      # --------------------
      # FETCH VERSIONS
      # --------------------
      - name: Gather versions and publish times
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          echo "Fetching versions & times for ${PKG} ..."
          npm view "${PKG}" versions --json > /tmp/versions.json
          npm view "${PKG}" time --json > /tmp/time.json

          CUR_VER=$(node -e "console.log(require('./package.json').version)")
          echo "Current repo version: $CUR_VER"
          echo "$CUR_VER" > /tmp/current_version.txt

      # --------------------
      # DECIDE WHAT TO REMOVE
      # --------------------
      - name: Decide versions to unpublish / deprecate
        env:
          UNPUBLISH_WINDOW_HOURS: ${{ env.UNPUBLISH_WINDOW_HOURS }}
        run: |
          set -euo pipefail
          node -e '
          const fs = require("fs");
          const versions = JSON.parse(fs.readFileSync("/tmp/versions.json","utf8")||"[]");
          const times = JSON.parse(fs.readFileSync("/tmp/time.json","utf8")||"{}");
          const current = fs.readFileSync("/tmp/current_version.txt","utf8").trim();

          const windowHours = Number(process.env.UNPUBLISH_WINDOW_HOURS || 72);
          const now = Date.now();

          const toUnpublish = [];
          const toDeprecate = [];

          for (const v of versions) {
            if (v === current) continue;
            const t = times[v] ? new Date(times[v]) : null;
            if (!t) { toDeprecate.push(v); continue; }
            const ageHours = (now - t.getTime()) / 36e5;
            if (ageHours <= windowHours) toUnpublish.push(v);
            else toDeprecate.push(v);
          }

          fs.writeFileSync("/tmp/to_unpublish.txt", toUnpublish.length ? toUnpublish.join("\n") + "\n" : "");
          fs.writeFileSync("/tmp/to_deprecate.txt", toDeprecate.length ? toDeprecate.join("\n") + "\n" : "");
          console.log("To unpublish (<= " + windowHours + "h):", toUnpublish);
          console.log("To deprecate (> " + windowHours + "h + unknown):", toDeprecate);
          '

          echo ""
          echo "=== Unpublish candidates ==="
          if [ -s /tmp/to_unpublish.txt ]; then cat /tmp/to_unpublish.txt; else echo "(none)"; fi

          echo ""
          echo "=== Deprecate candidates ==="
          if [ -s /tmp/to_deprecate.txt ]; then cat /tmp/to_deprecate.txt; else echo "(none)"; fi

      # --------------------
      # UNPUBLISH (verified, with fallback)
      # --------------------
      - name: Unpublish old versions (verified) and fallback to deprecate
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail

          verify_gone(){
            ver="$1"
            tries=8
            i=1
            while [ $i -le $tries ]; do
              echo "verify_gone: attempt $i for ${PKG}@${ver}"
              if npm view "${PKG}@${ver}" --json > /tmp/view_${ver}.json 2>&1; then
                echo "npm view still shows ${PKG}@${ver}"
                i=$((i+1))
                sleep 3
                continue
              else
                echo "npm view does NOT show ${PKG}@${ver} (gone)"
                return 0
              fi
            done
            return 1
          }

          if [ ! -s /tmp/to_unpublish.txt ]; then
            echo "No versions to unpublish."
          else
            while IFS= read -r ver; do
              ver="$(echo "$ver" | tr -d '\r' | xargs)"
              [ -z "$ver" ] && continue

              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "Attempting unpublish: ${PKG}@${ver}"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

              # capture output
              if npm unpublish "${PKG}@${ver}" 2>&1 | tee /tmp/npm_unpublish_${ver}.log; then
                echo "npm unpublish command returned success for ${PKG}@${ver}"
                # verify it's actually gone (poll a few times)
                if verify_gone "$ver"; then
                  echo "Verified ${PKG}@${ver} removed."
                else
                  echo "::warning::Still visible after unpublish attempts -> deprecate fallback"
                  npm deprecate "${PKG}@${ver}" "Deprecated — please upgrade to a newer release." 2>&1 | tee /tmp/npm_deprecate_${ver}.log || echo "::warning::deprecate failed for ${ver}"
                fi
              else
                echo "::warning::npm unpublish failed or returned non-zero for ${PKG}@${ver} (see /tmp/npm_unpublish_${ver}.log)"
                echo "Attempting to deprecate as fallback..."
                npm deprecate "${PKG}@${ver}" "Deprecated — please upgrade to a newer release." 2>&1 | tee /tmp/npm_deprecate_${ver}.log || echo "::warning::deprecate failed for ${ver}"
              fi

            done < /tmp/to_unpublish.txt
          fi

      # --------------------
      # DEPRECATE older (>72h)
      # --------------------
      - name: Deprecate older versions
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          if [ ! -s /tmp/to_deprecate.txt ]; then
            echo "No versions to deprecate."
            exit 0
          fi

          while IFS= read -r ver; do
            ver="$(echo "$ver" | tr -d '\r' | xargs)"
            [ -z "$ver" ] && continue
            echo "Deprecating ${PKG}@${ver}..."
            npm deprecate "${PKG}@${ver}" "Deprecated — please upgrade to a newer release." 2>&1 | tee /tmp/npm_deprecate_${ver}.log || echo "::warning::Deprecate failed for ${PKG}@${ver}"
          done < /tmp/to_deprecate.txt

      # --------------------
      # Final wait + verify final state
      # --------------------
      - name: Wait before final verify
        run: |
          echo "Short wait to let registry propagate final state..."
          sleep 8

      - name: Verify final state
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          echo "Final versions on npm:"
          npm view "${PKG}" versions --json || true
          echo ""
          echo "Latest version:"
          npm view "${PKG}" version || true

      # --------------------
      # Purge jsDelivr cache
      # --------------------
      - name: Purge jsDelivr cache
        run: |
          set -euo pipefail
          echo "Purging jsDelivr cache for ${PACKAGE_NAME} ..."
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@latest/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}/package.json" || true
          curl -i "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*" || true
          
          curl -i "https://purge.jsdelivr.net/gh/${PACKAGE_NAME_GH}@latest" || true
          curl -i "https://purge.jsdelivr.net/gh/${PACKAGE_NAME_GH}@*" || true
          echo "✅ jsDelivr cache purge requests sent"

      - name: Done
        run: echo "✓ Build, publish and cleanup complete"
