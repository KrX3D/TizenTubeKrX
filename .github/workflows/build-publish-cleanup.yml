name: Build, publish (on release) and cleanup old npm versions

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
  release:
    types: [published]

env:
  PACKAGE_NAME: '@krx3d/tizentube'
  NODE_VERSION: '20'
  UNPUBLISH_WINDOW_HOURS: '72'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install mods deps
        run: |
          set -euo pipefail
          cd mods
          npm ci

      - name: Build mods (rollup)
        run: |
          set -euo pipefail
          cd mods
          npx rollup -c

      - name: Install service deps
        run: |
          set -euo pipefail
          cd service
          npm ci

      - name: Build service (rollup)
        run: |
          set -euo pipefail
          cd service
          npx rollup -c

      - name: Verify dist output
        run: |
          set -euo pipefail
          ls -lh dist || true
          test -f dist/userScript.js
          test -f dist/service.js

  publish-and-clean:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${NPM_TOKEN:-}" ]; then
            echo "::error::NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc
          printf "always-auth=true\n" >> ~/.npmrc
          echo "✓ Configured npm authentication"

      - name: Publish package to npm
        run: |
          set -euo pipefail
          npm whoami
          npm publish --access public

      - name: Wait for npm propagation after publish
        run: sleep 15

      - name: Gather current version and list of old versions
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          
          echo "Fetching all versions for ${PKG}..."
          npm view "${PKG}" versions --json > /tmp/versions.json
          npm view "${PKG}" time --json > /tmp/time.json

          # Get current version from package.json
          CUR_VER=$(node -e "console.log(require('./package.json').version)")
          echo "Current published version: $CUR_VER"
          echo "$CUR_VER" > /tmp/current_version.txt
          
      - name: Determine versions to unpublish (exclude current)
        env:
          PKG: ${{ env.PACKAGE_NAME }}
          UNPUBLISH_WINDOW_HOURS: ${{ env.UNPUBLISH_WINDOW_HOURS }}
        run: |
          set -euo pipefail
          node -e '
          const fs = require("fs");
          const versions = JSON.parse(fs.readFileSync("/tmp/versions.json","utf8")||"[]");
          const times = JSON.parse(fs.readFileSync("/tmp/time.json","utf8")||"{}");
          const current = fs.readFileSync("/tmp/current_version.txt","utf8").trim();

          const windowHours = Number(process.env.UNPUBLISH_WINDOW_HOURS || "72");
          const now = Date.now();

          console.log("Current version to keep:", current);
          console.log("All versions on npm:", versions);

          // Convert to array if needed
          const arr = Array.isArray(versions) ? versions : Object.keys(versions||{});
          
          // Filter out current version
          const oldVersions = arr.filter(v => v !== current);
          
          console.log("Old versions (excluding current):", oldVersions);

          const items = oldVersions.map(v => ({
            v, 
            t: times[v] ? new Date(times[v]) : null
          }));

          const toUnpublish = [], toDeprecate = [];
          for (const it of items) {
            if (!it.t) {
              toDeprecate.push(it.v);
              continue;
            }
            const ageHours = (now - it.t.getTime()) / 36e5;
            if (ageHours <= windowHours) {
              toUnpublish.push(it.v);
            } else {
              toDeprecate.push(it.v);
            }
          }

          fs.writeFileSync("/tmp/to_unpublish.txt", toUnpublish.join("\n"));
          fs.writeFileSync("/tmp/to_deprecate.txt", toDeprecate.join("\n"));

          console.log("To unpublish (<= " + windowHours + "h):", toUnpublish);
          console.log("To deprecate (> " + windowHours + "h):", toDeprecate);
          ' 

          echo ""
          echo "=== Versions to unpublish ==="
          if [ -s /tmp/to_unpublish.txt ]; then 
            cat /tmp/to_unpublish.txt
          else 
            echo "(none)"
          fi
          
          echo ""
          echo "=== Versions to deprecate ==="
          if [ -s /tmp/to_deprecate.txt ]; then 
            cat /tmp/to_deprecate.txt
          else 
            echo "(none)"
          fi

      - name: Unpublish old versions (<=72h)
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          
          if [ ! -s /tmp/to_unpublish.txt ]; then
            echo "No versions to unpublish."
            exit 0
          fi

          echo "Unpublishing old versions..."
          while IFS= read -r ver; do
            [ -z "$ver" ] && continue
            
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "Unpublishing: ${PKG}@${ver}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            
            # Simple unpublish - just like the manual workflow
            if npm unpublish "${PKG}@${ver}"; then
              echo "✓ Unpublished ${PKG}@${ver}"
            else
              echo "::warning::Failed to unpublish ${PKG}@${ver}"
              # Try deprecate as fallback
              echo "Attempting to deprecate instead..."
              npm deprecate "${PKG}@${ver}" "Deprecated - please upgrade to latest version." || echo "::warning::Deprecate also failed"
            fi
            
          done < /tmp/to_unpublish.txt

      - name: Deprecate older versions (>72h)
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          
          if [ ! -s /tmp/to_deprecate.txt ]; then
            echo "No versions to deprecate."
            exit 0
          fi

          echo "Deprecating older versions..."
          while IFS= read -r ver; do
            [ -z "$ver" ] && continue
            
            echo "Deprecating ${PKG}@${ver}..."
            if npm deprecate "${PKG}@${ver}" "Deprecated - please upgrade to latest version."; then
              echo "✓ Deprecated ${PKG}@${ver}"
            else
              echo "::warning::Failed to deprecate ${PKG}@${ver}"
            fi
            
          done < /tmp/to_deprecate.txt

      - name: Wait for propagation
        run: sleep 15

      - name: Verify final state
        env:
          PKG: ${{ env.PACKAGE_NAME }}
        run: |
          set -euo pipefail
          
          echo "Final versions on npm:"
          npm view "${PKG}" versions --json || true
          
          echo ""
          echo "Latest version:"
          npm view "${PKG}" version || true

      - name: Purge jsDelivr cache
        run: |
          set -euo pipefail
          echo "Purging jsDelivr cache for ${PACKAGE_NAME}..."
          curl -s "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@latest/package.json" || true
          curl -s "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*/package.json" || true
          curl -s "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}/package.json" || true
          curl -s "https://purge.jsdelivr.net/npm/${PACKAGE_NAME}@*" || true
          echo "✓ jsDelivr cache purge complete"

      - name: Done
        run: echo "✓ Publish and cleanup complete"