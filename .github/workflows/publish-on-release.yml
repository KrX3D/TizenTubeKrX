# -----------------------------------------------------------------------------
# Build and publish TizenTube to npm
#
# WHAT THIS WORKFLOW DOES
# -----------------------
# - Runs on every push to the `main` branch (build + verification)
# - Runs again when a GitHub Release is published (build + npm publish)
# - Builds:
#     - dist/userScript.js  (browser userscript, bundled & minified)
#     - dist/service.js     (DIAL service, bundled with Rollup)
# - Publishes the package to https://www.npmjs.com on release only
# - Purges jsDelivr CDN cache after publishing
#
# WHEN IT RUNS
# ------------
# push to main:
#   - Builds the project
#   - Does NOT publish to npm
#
# release (published):
#   - Builds the project
#   - Publishes to npm
#   - Purges jsDelivr cache
#
# PREREQUISITES (REQUIRED)
# -----------------------
# 1) Create an npm account:
#    https://www.npmjs.com/signup
#
# 2) Create an npm access token:
#    - npm → Profile → Access Tokens
#    - Click "Generate New Token"
#    - Token name: anything you want
#    - CHECK: "Bypass two-factor authentication (2FA)"
#    - Packages and scopes:
#        - Permissions: Read and Write
#        - Scope: All packages
#    - Expiration date: e.g. 90 days
#    - Click "Generate token" and COPY it
#
# 3) Add the token to GitHub Secrets:
#    - GitHub repository → Settings
#    - Security → Secrets and variables → Actions
#    - Repository secrets → New repository secret
#        Name:   NPM_TOKEN
#        Secret: <paste npm token here>
#
# PACKAGE REQUIREMENTS
# --------------------
# - package.json must contain a unique name, e.g.:
#     "@krx3d/tizentube"
# - The version MUST be increased before each release
#   (npm will reject duplicate versions)
#
# HOW TO PUBLISH A NEW VERSION
# ----------------------------
# 1) Bump "version" in package.json
# 2) Commit and push to `main`
# 3) Create a GitHub Release
# 4) When the release is published:
#      → GitHub Actions builds
#      → npm publish runs automatically
#      → jsDelivr cache is purged
#
# -----------------------------------------------------------------------------

name: Build and publish on release

#on:
  #push:
    #branches:
      #- main
    #paths-ignore:
      - '.github/**'     # ignore any changes inside .github (workflow edits won't trigger this workflow)
      #- 'docs/**'
      #- 'README.md'
  #release:
    #types: [published]

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/

      # ----------------------------
      # Build mods (userScript.js)
      # ----------------------------
      - name: Install mods dependencies
        run: |
          set -euo pipefail
          cd mods
          npm ci

      - name: Build mods (rollup)
        run: |
          set -euo pipefail
          cd mods
          npx rollup -c

      # ----------------------------
      # Build service (service.js)
      # ----------------------------
      - name: Install service dependencies
        run: |
          set -euo pipefail
          cd service
          npm ci

      - name: Build service (rollup)
        run: |
          set -euo pipefail
          cd service
          npx rollup -c

      # ----------------------------
      # Verify output
      # ----------------------------
      - name: Verify dist output
        run: |
          set -euo pipefail
          ls -lh dist
          test -f dist/userScript.js
          test -f dist/service.js

      # ----------------------------
      # Publish to npm (release only)
      # ----------------------------
      - name: Publish package
        #if: github.event_name == 'release'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # ----------------------------
      # Purge jsDelivr cache (release only)
      # ----------------------------
      - name: Wait for npm propagation
        #if: github.event_name == 'release'
        run: sleep 10
        
      - name: Purge jsDelivr cache
        #if: github.event_name == 'release'
        run: |
          echo "Purging jsDelivr cache for @krx3d/tizentube..."
          
          # Purge latest tag
          curl -i "https://purge.jsdelivr.net/npm/@krx3d/tizentube@latest/package.json" || true
          
          # Purge all versions
          curl -i "https://purge.jsdelivr.net/npm/@krx3d/tizentube@*/package.json" || true
          
          # Purge default (no version)
          curl -i "https://purge.jsdelivr.net/npm/@krx3d/tizentube/package.json" || true
          
          # Purge entire package (all files)
          curl -i "https://purge.jsdelivr.net/npm/@krx3d/tizentube@*" || true
          
          echo "✅ jsDelivr cache purge requests sent"